---
title: "Martens"
author: "Clara Panchaud"
date: "2025-07-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(secr)
library(TMB)
library(expm)
library(tidyverse)
library(fields)

setwd("/Users/clara/Documents/RProjects/MMMPP_08/Martens1/Analysis_noac")
source("Functions/Fit_Func.r")
source("Functions/Sim_Func.r")
source("Functions/Extra_Func.r")
Rcpp::sourceCpp("Functions/LikelihoodC.cpp")

compile("Functions/like_MMPP.cpp")
dyn.load(dynlib("Functions/like_MMPP"))
set.seed(1)
```

```{r}
neighbour_matrix <- function(mesh, tol = 1e-6) {
  dist_mat <- as.matrix(dist(mesh))
  diag(dist_mat) <- Inf
  min_dist <- apply(dist_mat, 1, min)
  
  neighbour <- matrix(0, nrow = nrow(dist_mat), ncol = ncol(dist_mat))
  for (i in 1:nrow(dist_mat)) {
    neighbour[i, dist_mat[i, ] - min_dist[i] < tol] <- 1
  }
  
  return(neighbour)
}
```




```{r}
data <- read.csv("/Users/clara/Documents/RProjects/MMMPP_08/Martens1/Analysis_noac/marten_data.csv")
traps<-read.csv("/Users/clara/Documents/RProjects/MMMPP_08/Martens1/Analysis_noac/marten_traps.csv")
trap = make.poly(x=traps$x, y=traps$y)
mask = make.mask(trap,buffer=2,spacing=0.6,type="trapbuffer")
traps<-as.matrix(traps)
S <-dim(mask)[1]
S

```

```{r}
distance_traps<-proxy::dist(traps,mask)
traps_loc<-apply(distance_traps,1,which.min)

S <-dim(mask)[1]
n_traps<- 30

camera_count <- rep(1, S)
trap_counts <- table(traps_loc)
trap_counts
```


```{r}
q<- log(0.05) # transition rate
l<- 0.05 # observation rate
neighbour<-neighbour_matrix(mask)

data$y <- traps_loc[data$y]
Time <- 11
```

```{r}
dim(mask)
h <- attr(mask, "spacing")     # km
a <- h*h                   # km² per cell
A <- nrow(mask) * a 
r_km <- 0.03
A_foot <- pi*r_km
h*1000
```

```{r}
library(dplyr)
library(purrr)

# Split by id and extract y and Time into separate lists
df_grouped <- data %>% group_by(id) %>% arrange(Time, .by_group = TRUE)

mmpp <- list(
  ss = df_grouped %>% group_split() %>% map(~ .x$y),
  tt = df_grouped %>% group_split() %>% map(~ .x$Time)
)

mmpp$ss[[length(mmpp$ss) + 1]] <- NA
mmpp$tt[[length(mmpp$tt) + 1]] <- NA
```

```{r}
observed_idx <- which(!vapply(mmpp$tt, is.null, logical(1)))
      
      # Subset tt and ss
      mmpp$tt <- mmpp$tt[observed_idx]
      mmpp$ss <- mmpp$ss[observed_idx]
      
      observed_ind <- length(mmpp$tt)-1
      
        # Construct Q and lambda templates
      Q_fixed <- 1 - neighbour         # positions of structural zeros
      Q_template <- neighbour          # positions to fill with transition rates (neighbours)
      
      lambda_fixed <- rep(1,S)
      lambda_fixed[traps_loc] <- 0  # free parameters at active trap locations only
      lambda_template <- rep(0, S)
      lambda_template[traps_loc] <- 2
      
      # Initial distribution (uniform)
      f <- rep(1/S,S)
      
      # Build TMB data
      tmbdata <- list(
        Us = lengths(mmpp$tt),
        t = unlist(mmpp$tt),
        s = as.integer(unlist(mmpp$ss) - 1L),  # 0-based indexing for C++
        f = f,
        n_obs = observed_ind,
        t0 = 0,
        Time = Time,
        n_states = S,
        n_indiv = length(mmpp$tt),
        Q_template = Q_template,
        Q_fixed = Q_fixed,
        lambda_template = lambda_template,
        lambda_fixed = lambda_fixed
        
      )
      
      
      # where we have an NA in tt (no history) set the length to zero (in our case that will just be the last term)
      tmbdata$Us[unlist(lapply(mmpp$tt, \(x) all(is.na(x))))] <- 0
```


```{r}
theta_init <- rep(-2.5,2)
    
      start <- Sys.time()
    # make the autodiff function
      obj <- MakeADFun(data=tmbdata, parameters=list(theta=theta_init), DLL="like_MMPP")
    
       obj$fn((theta_init))
      # do the optimization
    invisible(capture.output({
      fit <- nlminb(start = theta_init, objective = obj$fn, gradient = obj$gr)
    }))
    
    end <- Sys.time()
    
    optimization_time <- difftime(end, start, units="secs")
    
      report<- sdreport(obj, par.fixed = fit$par)
      param<-summary(report)
       

```

```{r}
param
```

```{r}
 0.6095067 - 1.96 * 0.2350968
```


```{r}


# Calculate all results
Pop <- confint_pop_mmmpp(fit$par, Time, observed_ind, S, neighbour, traps_loc, f, report$cov)
nll <- obj$fn(fit$par)
AIC <- 2*2 + nll*2  # 2 parameters
D <- Pop[1]/A
SE.D <- Pop[2]/A
CI_lower <- D - 1.96 * SE.D
CI_upper <- D + 1.96 * SE.D

# Print nicely formatted results
cat("===============================================\n")
cat("           MODEL RESULTS SUMMARY              \n")
cat("===============================================\n\n")

cat("OPTIMIZATION:\n")
cat("  Computation time:      ", round(optimization_time, 2), " seconds\n")
cat("  Final log-likelihood:  ", round(obj$fn(fit$par), 4), "\n")
cat("  AIC:                   ", round(AIC, 2), "\n")
cat("  Number of states:      ", S, "\n\n")

cat("POPULATION ESTIMATES:\n")
cat("  Population size (N):   ", round(Pop[1], 2), " ± ", round(Pop[2], 2), "\n")
cat("  Study area (A):        ", round(A, 4), " km²\n")
cat("  Density (D):           ", round(D, 4), " animals/km²\n")
cat("  Density SE:            ", round(SE.D, 4), " animals/km²\n\n")

cat("CONFIDENCE INTERVALS:\n")
cat("  95% CI for Density:    [", round(CI_lower, 4), ", ", round(CI_upper, 4), "] animals/km²\n\n")

# Optional: Create a summary table
results_table <- data.frame(
  Metric = c("Population Size", "Density", "Log-likelihood", "AIC", "Optimization Time"),
  Estimate = c(round(Pop[1], 2), round(D, 4), round(obj$fn(fit$par), 4), round(AIC, 2), paste(round(optimization_time, 2), "sec")),
  SE = c(round(Pop[2], 2), round(SE.D, 4), "", "", ""),
  CI_Lower = c("", round(CI_lower, 4), "", "", ""),
  CI_Upper = c("", round(CI_upper, 4), "", "", ""),
  stringsAsFactors = FALSE
)

cat("SUMMARY TABLE:\n")
print(results_table, row.names = FALSE, right = FALSE)

cat("\n===============================================\n")
```


S=128 we get:

Population Size	15.81	3.07		
Density	0.1525	0.0296	0.0945	0.2105
Log-likelihood	124.9033			
AIC	253.81			
Optimization Time	8.16 sec

S=203 we get:

Population Size	18.61	4.03		
Density	0.187	0.0406	0.1075	0.2665
Log-likelihood	123.1709			
AIC	250.34			
Optimization Time	29.46 sec

